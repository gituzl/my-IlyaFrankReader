<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ilya Frank Reader AI (V3 Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* 通用滑块样式 */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
            height: 24px; 
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #f59e0b; 
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]:focus { outline: none; }
        
        /* 底部安全区适配 */
        .safe-pb { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .mobile-pb-fix { padding-bottom: 140px; }

        /* 修复阅读区高亮 */
        .word-hover:hover {
            background-color: #fde68a; /* amber-200 */
            color: #78350f; /* amber-900 */
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            Play, Pause, RotateCcw, BookOpen, Type, Settings, 
            Volume2, Save, X, Loader2, Globe, Sparkles, 
            CheckCircle2, RotateCw, Wifi, Sliders, Music, Eraser, Layers, Zap
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        // -----------------------------------------------------------------------------
        // CONFIGURATION
        // -----------------------------------------------------------------------------
        const LANGUAGES = {
            en: { label: 'English (英语)', ttsCode: 'en-US', azureVoice: 'en-US-JennyNeural', prompt: 'English' },
            fr: { label: 'Français (法语)', ttsCode: 'fr-FR', azureVoice: 'fr-FR-DeniseNeural', prompt: 'French' },
            ru: { label: 'Русский (俄语)', ttsCode: 'ru-RU', azureVoice: 'ru-RU-SvetlanaNeural', prompt: 'Russian' },
            de: { label: 'Deutsch (德语)', ttsCode: 'de-DE', azureVoice: 'de-DE-KatjaNeural', prompt: 'German' },
            es: { label: 'Español (西语)', ttsCode: 'es-ES', azureVoice: 'es-ES-ElviraNeural', prompt: 'Spanish' },
            jp: { label: '日本語 (日语)', ttsCode: 'ja-JP', azureVoice: 'ja-JP-NanamiNeural', prompt: 'Japanese' }
        };

        const CEFR_LEVELS = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];

        const DEFAULT_SETTINGS = {
            llmProvider: 'custom', 
            llmBaseUrl: 'https://api.siliconflow.cn/v1', 
            llmApiKey: '', 
            llmModel: 'deepseek-ai/DeepSeek-V2.5', 
            ttsProvider: 'browser', 
            ttsVoice: 'alloy', 
            azureRegion: 'eastus',
            azureKey: '',
            parsingGranularity: 2 // 1=Fine, 2=Standard, 3=Coarse
        };

        const SAMPLE_CONTENT = {
            title: "示例：小王子 (俄语)",
            raw: `Мама мыла раму. Это очень известное предложение.`,
            ilyaSegments: [
                { original: "Мама", cn: "妈妈" },
                { original: "мыла", cn: "洗了 (原形: мыть)" },
                { original: "раму", cn: "窗框" },
                { original: "Это", cn: "这" },
                { original: "очень известное", cn: "非常著名的" },
                { original: "предложение", cn: "句子" }
            ],
            lang: 'ru'
        };

        // -----------------------------------------------------------------------------
        // COMPONENTS
        // -----------------------------------------------------------------------------

        // --- Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            const [llmTestStatus, setLlmTestStatus] = useState('idle');
            const [azureTestStatus, setAzureTestStatus] = useState('idle');

            useEffect(() => {
                if (isOpen) {
                    setLocalSettings(settings);
                    setLlmTestStatus('idle'); setAzureTestStatus('idle');
                }
            }, [isOpen, settings]);

            const handleChange = (key, value) => {
                setLocalSettings(prev => ({ ...prev, [key]: value }));
                if (key.startsWith('llm')) setLlmTestStatus('idle');
                if (key.startsWith('azure')) setAzureTestStatus('idle');
            };
            
            const getGranularityLabel = (val) => {
                switch(parseInt(val)) {
                    case 1: return "精细 (拆分为单词/短语)";
                    case 2: return "标准 (按意群/逻辑拆分)";
                    case 3: return "粗略 (整句/长从句)";
                    default: return "标准";
                }
            };

            const testLLMConnection = async () => {
                if (!localSettings.llmApiKey) { alert("错误：请先输入 API Key"); return; }
                setLlmTestStatus('loading');
                try {
                    const response = await fetch(`${localSettings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localSettings.llmApiKey}` },
                        body: JSON.stringify({ model: localSettings.llmModel, messages: [{ role: "user", content: "Hi" }], max_tokens: 5 })
                    });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    setLlmTestStatus('success');
                    alert("连接成功！");
                } catch (error) { setLlmTestStatus('error'); alert(`连接失败: ${error.message}`); }
            };

            const testAzureConnection = async () => {
                if (!localSettings.azureKey || !localSettings.azureRegion) { alert("错误：请补全 Region 和 Key"); return; }
                setAzureTestStatus('loading');
                try {
                    const endpoint = `https://${localSettings.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`;
                    const ssml = `<speak version='1.0' xml:lang='en-US'><voice xml:lang='en-US' xml:gender='Female' name='en-US-JennyNeural'>Test</voice></speak>`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Ocp-Apim-Subscription-Key': localSettings.azureKey, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' },
                        body: ssml
                    });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    setAzureTestStatus('success');
                    alert("Azure 连接成功！");
                } catch (error) { setAzureTestStatus('error'); alert(`Azure 测试失败: ${error.message}`); }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Settings className="w-5 h-5 text-amber-600" />设置</h2>
                            <button onClick={onClose} className="p-2 -mr-2 text-gray-400 hover:text-gray-600 rounded-full active:bg-gray-200"><X className="w-6 h-6" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-8 custom-scrollbar">
                            <div className="space-y-4">
                                <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider border-b pb-1 flex items-center gap-2"><Layers className="w-4 h-4" /> 解析粒度</h3>
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-100">
                                    <label className="flex justify-between items-center mb-3">
                                        <span className="text-sm font-medium text-gray-700">分割程度</span>
                                        <span className="text-xs font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded border border-amber-200">{getGranularityLabel(localSettings.parsingGranularity)}</span>
                                    </label>
                                    <div className="relative pt-1">
                                        <input type="range" min="1" max="3" step="1" value={localSettings.parsingGranularity || 2} onChange={(e) => handleChange('parsingGranularity', parseInt(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600" />
                                        <div className="flex justify-between text-[10px] text-gray-400 mt-2 font-mono"><span>| 单词</span><span>| 意群</span><span>| 整句</span></div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-3 leading-relaxed">* 调整此选项可显著改变解析结果：单词级适合精读，整句级适合泛读。</p>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b pb-1">
                                    <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider">AI 模型设置</h3>
                                    {llmTestStatus === 'success' && <span className="text-xs text-green-600 flex items-center"><CheckCircle2 className="w-3 h-3 mr-1"/>已连接</span>}
                                </div>
                                <div className="space-y-3">
                                    <div><label className="text-xs text-gray-500 block mb-1">Base URL</label><input type="text" value={localSettings.llmBaseUrl} onChange={(e) => handleChange('llmBaseUrl', e.target.value)} placeholder="https://api.openai.com/v1" className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 outline-none focus:ring-2 focus:ring-amber-500" /></div>
                                    <div><label className="text-xs text-gray-500 block mb-1">API Key</label><input type="password" value={localSettings.llmApiKey} onChange={(e) => handleChange('llmApiKey', e.target.value)} placeholder="sk-..." className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 outline-none focus:ring-2 focus:ring-amber-500" /></div>
                                    <div><label className="text-xs text-gray-500 block mb-1">Model Name</label><input type="text" value={localSettings.llmModel} onChange={(e) => handleChange('llmModel', e.target.value)} placeholder="gpt-3.5-turbo" className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 outline-none focus:ring-2 focus:ring-amber-500" /></div>
                                    <div className="flex justify-end"><button onClick={testLLMConnection} className="text-xs border border-amber-200 text-amber-700 px-4 py-2 rounded-lg hover:bg-amber-50 flex items-center gap-1 transition-colors">{llmTestStatus === 'loading' ? <Loader2 className="w-3 h-3 animate-spin"/> : <Wifi className="w-3 h-3" />} 测试连接</button></div>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider border-b pb-1">语音设置</h3>
                                <div className="flex flex-col gap-2">
                                    {['browser', 'openai', 'azure'].map(p => (
                                        <label key={p} className={`flex items-center gap-3 cursor-pointer p-3 rounded-lg border transition-all active:scale-[0.99] ${localSettings.ttsProvider === p ? 'bg-amber-50 border-amber-300 ring-1 ring-amber-300' : 'border-gray-200 hover:bg-gray-50'}`}>
                                            <input type="radio" name="ttsProvider" checked={localSettings.ttsProvider === p} onChange={() => handleChange('ttsProvider', p)} className="w-4 h-4 accent-amber-600" />
                                            <div className="flex flex-col"><span className="text-sm font-medium text-gray-700">{p === 'browser' ? '浏览器原生 (免费)' : p === 'openai' ? 'OpenAI TTS' : 'Azure Speech'}</span><span className="text-xs text-gray-400">{p === 'browser' ? '仅实时朗读' : '支持生成 MP3'}</span></div>
                                        </label>
                                    ))}
                                </div>
                                {localSettings.ttsProvider === 'azure' && (<div className="space-y-3 bg-blue-50 p-4 rounded-lg border border-blue-100"><input type="text" value={localSettings.azureRegion} onChange={(e) => handleChange('azureRegion', e.target.value)} placeholder="Region" className="w-full p-2 border rounded text-sm font-mono" /><input type="password" value={localSettings.azureKey} onChange={(e) => handleChange('azureKey', e.target.value)} placeholder="Key" className="w-full p-2 border rounded text-sm font-mono" /><div className="flex justify-end"><button onClick={testAzureConnection} className="text-xs border px-3 py-1 rounded hover:bg-white flex items-center gap-1"><Wifi className="w-3 h-3" /> 测试 Azure</button></div></div>)}
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end gap-3 safe-pb"><button onClick={() => onSave(localSettings)} className="flex items-center gap-2 bg-amber-600 text-white px-6 py-2.5 rounded-lg hover:bg-amber-700 shadow-sm transition-transform active:scale-95 font-medium w-full justify-center md:w-auto"><Save className="w-4 h-4" /> 保存设置</button></div>
                    </div>
                </div>
            );
        };

        // --- Optimized Clickable Word (Fix Spacing) ---
        // 关键修复：不再使用 block 或 inline-block，仅对文字包裹 inline 样式，空格保持原样
        const ClickableWord = ({ text, onSpeak, langCode, className = "" }) => {
            if (!text) return null;
            // 按空格分割，但保留分隔符
            const segments = text.split(/(\s+)/);
            
            return (
                <span className="inline">
                    {segments.map((seg, index) => {
                        // 如果是纯空格，直接渲染，不加点击事件，避免怪异间距
                        if (/^\s+$/.test(seg)) {
                            return <span key={index}>{seg}</span>;
                        }
                        return (
                            <span 
                                key={index} 
                                onClick={(e) => { e.stopPropagation(); onSpeak(seg.replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, ""), langCode); }}
                                className={`cursor-pointer transition-colors duration-150 select-text word-hover inline border-b-2 border-transparent hover:border-amber-300 py-0.5 ${className}`}
                            >
                                {seg}
                            </span>
                        );
                    })}
                </span>
            );
        };

        // -----------------------------------------------------------------------------
        // MAIN APP
        // -----------------------------------------------------------------------------
        const IlyaFrankReader = () => {
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [showSettings, setShowSettings] = useState(false);
            const [inputText, setInputText] = useState("");
            const [ilyaData, setIlyaData] = useState([]);
            const [rawText, setRawText] = useState("");
            const [targetLang, setTargetLang] = useState('en'); 
            const [targetLevel, setTargetLevel] = useState('B1'); 
            const [isProcessing, setIsProcessing] = useState(false); 
            const [isGenerating, setIsGenerating] = useState(false); 
            
            // Audio State
            const [fullAudioUrl, setFullAudioUrl] = useState(null);
            const [isGeneratingAudio, setIsGeneratingAudio] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [playbackRate, setPlaybackRate] = useState(1.0); // Default 1.0

            const synthRef = useRef(window.speechSynthesis);
            const audioRef = useRef(new Audio());

            useEffect(() => {
                const saved = localStorage.getItem('ilya_reader_settings');
                if (saved) { try { setSettings({ ...DEFAULT_SETTINGS, ...JSON.parse(saved) }); } catch (e) {} }
            }, []);

            useEffect(() => { return () => { if (fullAudioUrl) URL.revokeObjectURL(fullAudioUrl); }; }, [fullAudioUrl]);

            // Audio Player Listeners & Rate Fix
            useEffect(() => {
                const audio = audioRef.current;
                const updateTime = () => setCurrentTime(audio.currentTime);
                const updateDuration = () => setDuration(audio.duration);
                const onEnded = () => setIsPlaying(false);
                const onError = (e) => { console.error("Audio error", e); setIsPlaying(false); };
                
                // 关键修复：当音频加载或开始播放时，强制应用当前的 playbackRate
                const applyRate = () => { audio.playbackRate = playbackRate; };

                audio.addEventListener('timeupdate', updateTime);
                audio.addEventListener('loadedmetadata', updateDuration);
                audio.addEventListener('loadeddata', applyRate); // Fix: Re-apply on load
                audio.addEventListener('play', applyRate);       // Fix: Re-apply on play
                audio.addEventListener('ended', onEnded);
                audio.addEventListener('error', onError);

                return () => {
                    audio.removeEventListener('timeupdate', updateTime);
                    audio.removeEventListener('loadedmetadata', updateDuration);
                    audio.removeEventListener('loadeddata', applyRate);
                    audio.removeEventListener('play', applyRate);
                    audio.removeEventListener('ended', onEnded);
                    audio.removeEventListener('error', onError);
                    audio.pause();
                };
            }, [playbackRate]); // Dependency on playbackRate ensures closure freshness if needed, though we set prop directly below

            // Keep rate synced
            useEffect(() => {
                if (audioRef.current) audioRef.current.playbackRate = playbackRate;
            }, [playbackRate]);

            const handleWordClick = async (text, langCode) => {
                if (!text || !text.trim()) return;
                if (isPlaying) {
                    if (settings.ttsProvider === 'browser') synthRef.current.cancel();
                    else audioRef.current.pause();
                    setIsPlaying(false);
                }
                if (settings.ttsProvider === 'browser' || true) {
                    synthRef.current.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langCode || LANGUAGES[targetLang].ttsCode; 
                    u.rate = 0.9; 
                    synthRef.current.speak(u);
                }
            };

            const generateFullAudio = async () => {
                if (!rawText) return alert("请先在左侧输入文本并点击'智能解析'或'生成'");
                if (settings.ttsProvider === 'browser') return alert("提示：浏览器原生 TTS 仅支持实时朗读。如需生成音频文件，请切换到 OpenAI 或 Azure。");
                setIsGeneratingAudio(true);
                audioRef.current.pause();
                setIsPlaying(false);
                if (fullAudioUrl) URL.revokeObjectURL(fullAudioUrl);
                setFullAudioUrl(null);

                try {
                    let blob;
                    // ... (API calls same as before)
                    if (settings.ttsProvider === 'openai') {
                        if (!settings.llmApiKey) throw new Error("请在设置中填写 API Key");
                        const response = await fetch(`${settings.llmBaseUrl}/audio/speech`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${settings.llmApiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: 'tts-1', input: rawText, voice: settings.ttsVoice, speed: 1.0 })
                        });
                        if (!response.ok) throw new Error("TTS 请求失败");
                        blob = await response.blob();
                    } else if (settings.ttsProvider === 'azure') {
                        if (!settings.azureKey) throw new Error("请填写 Azure Key");
                        const voiceName = LANGUAGES[targetLang].azureVoice;
                        const response = await fetch(`https://${settings.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`, {
                            method: 'POST',
                            headers: { 'Ocp-Apim-Subscription-Key': settings.azureKey, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' },
                            body: `<speak version='1.0' xml:lang='${LANGUAGES[targetLang].ttsCode}'><voice xml:lang='${LANGUAGES[targetLang].ttsCode}' xml:gender='Female' name='${voiceName}'>${rawText}</voice></speak>`
                        });
                        if (!response.ok) throw new Error("Azure 请求失败");
                        blob = await response.blob();
                    }
                    if(blob) {
                        const url = URL.createObjectURL(blob);
                        setFullAudioUrl(url);
                        audioRef.current.src = url;
                        audioRef.current.load();
                    }
                } catch (e) { alert("音频生成失败: " + e.message); } finally { setIsGeneratingAudio(false); }
            };

            const togglePlay = () => {
                if (settings.ttsProvider === 'browser') {
                    if (isPlaying) { synthRef.current.cancel(); setIsPlaying(false); } 
                    else {
                        if(!rawText) return;
                        const u = new SpeechSynthesisUtterance(rawText);
                        u.lang = LANGUAGES[targetLang].ttsCode;
                        u.rate = playbackRate; // Apply rate
                        u.onend = () => setIsPlaying(false);
                        synthRef.current.cancel(); 
                        synthRef.current.speak(u);
                        setIsPlaying(true);
                    }
                    return;
                }
                if (!fullAudioUrl) {
                    generateFullAudio().then(() => { if (audioRef.current.src) { audioRef.current.play(); setIsPlaying(true); } });
                } else {
                    if (isPlaying) { audioRef.current.pause(); setIsPlaying(false); } 
                    else { audioRef.current.play(); setIsPlaying(true); }
                }
            };

            const handleSeek = (e) => {
                const time = parseFloat(e.target.value);
                setCurrentTime(time);
                audioRef.current.currentTime = time;
            };

            const generateText = async () => {
                if (!settings.llmApiKey) return alert("请先在设置中配置 API Key");
                setIsGenerating(true);
                try {
                    const prompt = `Write a ${CEFR_LEVELS.indexOf(targetLevel) < 2 ? 'simple' : 'complex'} story in ${LANGUAGES[targetLang].prompt} (CEFR ${targetLevel}, ~300 words). Output the story text ONLY. No Markdown.`;
                    const response = await fetch(`${settings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.llmApiKey}` },
                        body: JSON.stringify({ model: settings.llmModel, messages: [{ role: "user", content: prompt }], temperature: 0.7 })
                    });
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content?.replace(/```/g, '').trim() || "";
                    setInputText(content);
                } catch (error) { alert("生成失败: " + error.message); } finally { setIsGenerating(false); }
            };

            // --- Optimized Parser (Speed & Granularity) ---
            const parseText = async () => {
                if (!inputText.trim()) return alert("请输入文本");
                if (!settings.llmApiKey) return alert("请配置 API Key");
                
                setIsProcessing(true);
                setRawText(inputText);
                setFullAudioUrl(null); 
                
                try {
                    const langName = LANGUAGES[targetLang].prompt;
                    
                    // 粒度指令 - 放在 System Prompt 中以提高权重
                    let gInstruction = "Standard parsing: split by natural logical phrases (sense groups).";
                    if (settings.parsingGranularity === 1) gInstruction = "Detailed parsing: split into very small chunks (single words or short idioms).";
                    if (settings.parsingGranularity === 3) gInstruction = "Coarse parsing: split by full sentences or independent clauses ONLY.";

                    const systemPrompt = `You are a strict JSON generator for Ilya Frank's Reading Method.
                    TARGET LANGUAGE: ${langName}.
                    RULE: ${gInstruction}
                    FORMAT: JSON Array [{"original": "...", "cn": "..."}] only.
                    IMPORTANT: "original" field MUST REMAIN in ${langName}. DO NOT TRANSLATE IT TO ENGLISH.
                    `;

                    const response = await fetch(`${settings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.llmApiKey}` },
                        body: JSON.stringify({ 
                            model: settings.llmModel, 
                            messages: [
                                { role: "system", content: systemPrompt }, 
                                { role: "user", content: inputText }
                            ], 
                            temperature: 0, // Lower temp for speed and deterministic format
                            max_tokens: 4000
                        })
                    });
                    
                    const data = await response.json();
                    let content = data.choices?.[0]?.message?.content || "";
                    
                    content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = content.indexOf('[');
                    const end = content.lastIndexOf(']');
                    if (start !== -1 && end !== -1) content = content.substring(start, end + 1);
                    
                    const parsed = JSON.parse(content);
                    const normalized = parsed.map(item => ({
                        original: item.original || item.en || item.text, 
                        cn: item.cn || item.zh || item.translation
                    }));
                    setIlyaData(normalized);
                } catch (error) { 
                    console.error(error); 
                    alert("解析失败: " + error.message); 
                } finally { 
                    setIsProcessing(false); 
                }
            };

            const loadSample = () => {
                setTargetLang(SAMPLE_CONTENT.lang); 
                setInputText(SAMPLE_CONTENT.raw);
                setRawText(SAMPLE_CONTENT.raw); 
                setIlyaData(SAMPLE_CONTENT.ilyaSegments); 
                setFullAudioUrl(null);
            };

            const saveSettings = (s) => { setSettings(s); localStorage.setItem('ilya_reader_settings', JSON.stringify(s)); setShowSettings(false); };

            return (
                <div className="min-h-screen flex flex-col mobile-pb-fix"> 
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} onSave={saveSettings} />

                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-amber-100 p-2 rounded-lg"><BookOpen className="text-amber-600 w-5 h-5" /></div>
                                <div><h1 className="text-lg font-bold text-slate-800 leading-tight">Ilya Frank</h1></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={loadSample} className="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors md:px-3 md:py-1.5 md:rounded-md flex items-center"><RotateCcw className="w-5 h-5 md:w-3.5 md:h-3.5"/> <span className="hidden md:inline ml-1 text-xs font-medium">示例</span></button>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-800 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors md:bg-slate-800 md:text-white md:hover:bg-slate-700 md:px-3 md:py-1.5 md:rounded-md flex items-center shadow-sm"><Settings className="w-5 h-5 md:w-3.5 md:h-3.5"/><span className="hidden md:inline ml-1 text-xs font-medium">设置</span></button>
                            </div>
                        </div>
                    </header>

                    <main className="flex-grow max-w-7xl mx-auto w-full p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                        <div className="flex flex-col gap-4 h-full">
                            <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-5 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2"><Globe className="w-4 h-4 text-amber-500" /> 原文</h2>
                                    <div className="flex gap-2">
                                         <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)} className="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-md px-2 py-1 outline-none focus:border-amber-500">{Object.entries(LANGUAGES).map(([c, cfg]) => <option key={c} value={c}>{cfg.label}</option>)}</select>
                                        <button onClick={() => setInputText('')} className="text-slate-400 hover:text-red-500 transition-colors p-2" title="清空"><Eraser className="w-4 h-4"/></button>
                                    </div>
                                </div>
                                <textarea value={inputText} onChange={(e) => setInputText(e.target.value)} placeholder="在此粘贴俄语、德语等文章片段..." className="w-full p-4 rounded-lg border border-slate-200 min-h-[180px] md:min-h-[240px] text-base leading-relaxed resize-y focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none bg-slate-50 font-serif" />
                                <div className="flex flex-col sm:flex-row items-center justify-between gap-3 pt-2 border-t border-slate-100">
                                    <div className="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start">
                                        <div className="flex items-center gap-2"><span className="text-xs text-slate-400">AI素材:</span><select value={targetLevel} onChange={(e) => setTargetLevel(e.target.value)} className="bg-white border text-xs rounded px-1 py-1">{CEFR_LEVELS.map(l => <option key={l} value={l}>{l}</option>)}</select></div>
                                        <button onClick={generateText} disabled={isGenerating} className="text-xs text-amber-600 hover:text-amber-700 flex items-center gap-1 font-medium disabled:opacity-50 px-2 py-1 bg-amber-50 rounded">{isGenerating ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>} 生成故事</button>
                                    </div>
                                    <button onClick={parseText} disabled={isProcessing || !inputText.trim()} className="w-full sm:w-auto bg-amber-600 text-white px-5 py-2.5 rounded-lg text-sm font-semibold shadow-sm hover:bg-amber-700 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all active:scale-95">{isProcessing ? <Loader2 className="w-4 h-4 animate-spin"/> : <Type className="w-4 h-4"/>} 开始解析</button>
                                </div>
                            </section>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col h-full">
                             <div className="px-5 py-3 border-b border-slate-100 bg-amber-50/30 flex justify-between items-center rounded-t-xl">
                                <h2 className="font-bold text-slate-700 flex items-center gap-2"><BookOpen className="w-4 h-4 text-amber-500" /> 阅读区</h2>
                            </div>
                            <div className="p-4 md:p-6 flex-grow overflow-y-auto max-h-[60vh] md:max-h-[calc(100vh-250px)] touch-pan-y">
                                {ilyaData.length > 0 ? (
                                    <div className="text-lg leading-loose font-serif text-slate-800 text-justify">
                                        {ilyaData.map((seg, idx) => (
                                            <span key={idx} className="inline">
                                                <ClickableWord text={seg.original} langCode={LANGUAGES[targetLang].ttsCode} onSpeak={handleWordClick} className="font-semibold text-slate-900" />
                                                {seg.cn && <span className="text-base text-slate-500 font-sans bg-slate-100 px-1.5 py-0.5 rounded-md inline-block my-1 mx-1">({seg.cn})</span>}
                                                {/* 添加自然空格，防止粘连，但不由 margin 控制 */}
                                                {" "} 
                                            </span>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-300 py-20"><BookOpen className="w-12 h-12 mb-4 opacity-20" /><p>等待解析...</p></div>
                                )}
                            </div>
                        </div>
                    </main>

                    <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] z-30 safe-pb px-4 py-3">
                        <div className="max-w-4xl mx-auto flex flex-col gap-2">
                            <div className="flex items-center gap-3 w-full">
                                <span className="text-xs text-slate-400 font-mono w-10 text-right">{formatTime(currentTime)}</span>
                                <input type="range" min="0" max={duration || 100} value={currentTime} onChange={handleSeek} disabled={!fullAudioUrl && settings.ttsProvider !== 'browser'} className="flex-grow accent-amber-600 disabled:opacity-50 h-8" />
                                <span className="text-xs text-slate-400 font-mono w-10">{formatTime(duration)}</span>
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 w-24 md:w-32">
                                     <Volume2 className="w-4 h-4 text-slate-400" />
                                     <select value={playbackRate} onChange={(e) => setPlaybackRate(parseFloat(e.target.value))} className="bg-slate-100 border-none text-xs rounded px-2 py-1.5 text-slate-600 outline-none">
                                        <option value="0.5">0.5x</option>
                                        <option value="0.8">0.8x</option>
                                        <option value="1.0">1.0x</option>
                                        <option value="1.2">1.2x</option>
                                        <option value="1.5">1.5x</option>
                                        <option value="2.0">2.0x</option>
                                     </select>
                                </div>
                                <button onClick={togglePlay} disabled={isGeneratingAudio} className={`w-12 h-12 flex items-center justify-center rounded-full text-white shadow-lg shadow-amber-200 transition-all active:scale-95 disabled:bg-slate-300 disabled:shadow-none ${isPlaying ? 'bg-amber-600 hover:bg-amber-700' : 'bg-amber-500 hover:bg-amber-600'}`}>
                                    {isGeneratingAudio ? <Loader2 className="w-5 h-5 animate-spin" /> : isPlaying ? <Pause className="w-5 h-5 fill-current" /> : <Play className="w-5 h-5 fill-current ml-1" />}
                                </button>
                                <div className="w-24 md:w-32 flex justify-end">
                                    {settings.ttsProvider !== 'browser' && !fullAudioUrl && (
                                        <button onClick={generateFullAudio} disabled={!rawText || isGeneratingAudio} className="flex items-center gap-1 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors font-medium whitespace-nowrap"><Music className="w-3 h-3" /> <span className="hidden sm:inline">生成音频</span><span className="sm:hidden">生成</span></button>
                                    )}
                                    {settings.ttsProvider === 'browser' && <span className="text-xs text-slate-400">浏览器朗读</span>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const formatTime = (seconds) => {
            if (!seconds || isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<IlyaFrankReader />);
    </script>
</body>
</html>
