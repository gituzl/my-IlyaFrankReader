<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ilya Frank Reader AI (Mobile Optimized)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; color: #334155; -webkit-tap-highlight-color: transparent; }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* é€šç”¨æ»‘å—æ ·å¼ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
            height: 24px; /* å¢åŠ è§¦æ‘¸é«˜åº¦ */
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: #f59e0b; 
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        input[type=range]:focus { outline: none; }
        
        /* åº•éƒ¨å®‰å…¨åŒºé€‚é… (iPhone X+) */
        .safe-pb { 
            padding-bottom: calc(12px + env(safe-area-inset-bottom)); 
        }
        
        /* ç§»åŠ¨ç«¯ä¸»å®¹å™¨ç•™ç™½ï¼Œé˜²æ­¢è¢«åº•éƒ¨æ’­æ”¾å™¨é®æŒ¡ */
        .mobile-pb-fix {
            padding-bottom: 140px; /* ç•™å‡ºè¶³å¤Ÿçš„ç©ºé—´ç»™æ’­æ”¾å™¨ */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0?dev';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client?dev';
        import { 
            Play, Pause, RotateCcw, BookOpen, Type, Settings, 
            Volume2, Save, X, Loader2, Globe, Sparkles, 
            CheckCircle2, RotateCw, Wifi, Sliders, Music, Eraser, Layers
        } from 'https://esm.sh/lucide-react@0.263.1?dev';

        // -----------------------------------------------------------------------------
        // CONFIGURATION
        // -----------------------------------------------------------------------------
        const LANGUAGES = {
            en: { label: 'English (è‹±è¯­)', ttsCode: 'en-US', azureVoice: 'en-US-JennyNeural', prompt: 'English' },
            fr: { label: 'FranÃ§ais (æ³•è¯­)', ttsCode: 'fr-FR', azureVoice: 'fr-FR-DeniseNeural', prompt: 'French' },
            ru: { label: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹ (ä¿„è¯­)', ttsCode: 'ru-RU', azureVoice: 'ru-RU-SvetlanaNeural', prompt: 'Russian' },
            de: { label: 'Deutsch (å¾·è¯­)', ttsCode: 'de-DE', azureVoice: 'de-DE-KatjaNeural', prompt: 'German' },
            es: { label: 'EspaÃ±ol (è¥¿è¯­)', ttsCode: 'es-ES', azureVoice: 'es-ES-ElviraNeural', prompt: 'Spanish' },
            jp: { label: 'æ—¥æœ¬èª (æ—¥è¯­)', ttsCode: 'ja-JP', azureVoice: 'ja-JP-NanamiNeural', prompt: 'Japanese' }
        };

        const CEFR_LEVELS = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];

        const DEFAULT_SETTINGS = {
            llmProvider: 'custom', 
            llmBaseUrl: 'https://api.siliconflow.cn/v1', 
            llmApiKey: '', 
            llmModel: 'deepseek-ai/DeepSeek-V2.5', 
            ttsProvider: 'browser', 
            ttsVoice: 'alloy', 
            azureRegion: 'eastus',
            azureKey: '',
            parsingGranularity: 2 // 1=Small/Detail, 2=Medium/Default, 3=Large/Sentence
        };

        const SAMPLE_CONTENT = {
            title: "ç¤ºä¾‹ï¼šå°ç‹å­ (ä¿„è¯­)",
            raw: `ĞœĞ°Ğ¼Ğ° Ğ¼Ñ‹Ğ»Ğ° Ñ€Ğ°Ğ¼Ñƒ. Ğ­Ñ‚Ğ¾ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ.`,
            ilyaSegments: [
                { original: "ĞœĞ°Ğ¼Ğ°", cn: "å¦ˆå¦ˆ" },
                { original: "Ğ¼Ñ‹Ğ»Ğ°", cn: "æ´—äº† (åŸå½¢: Ğ¼Ñ‹Ñ‚ÑŒ)" },
                { original: "Ñ€Ğ°Ğ¼Ñƒ", cn: "çª—æ¡†" },
                { original: "Ğ­Ñ‚Ğ¾", cn: "è¿™" },
                { original: "Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ", cn: "éå¸¸è‘—åçš„" },
                { original: "Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ", cn: "å¥å­" }
            ],
            lang: 'ru'
        };

        // -----------------------------------------------------------------------------
        // COMPONENTS
        // -----------------------------------------------------------------------------

        // --- 1. Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            const [llmTestStatus, setLlmTestStatus] = useState('idle');
            const [azureTestStatus, setAzureTestStatus] = useState('idle');

            useEffect(() => {
                if (isOpen) {
                    setLocalSettings(settings);
                    setLlmTestStatus('idle'); 
                    setAzureTestStatus('idle');
                }
            }, [isOpen, settings]);

            const handleChange = (key, value) => {
                setLocalSettings(prev => ({ ...prev, [key]: value }));
                if (key.startsWith('llm')) setLlmTestStatus('idle');
                if (key.startsWith('azure')) setAzureTestStatus('idle');
            };
            
            // ç²’åº¦è¯´æ˜æ–‡æ¡ˆ
            const getGranularityLabel = (val) => {
                switch(parseInt(val)) {
                    case 1: return "ç²¾ç»† (é€‚åˆåˆå­¦è€…ï¼Œæ‹†åˆ†åˆ°å•è¯/çŸ­è¯­)";
                    case 2: return "æ ‡å‡† (é»˜è®¤ï¼ŒæŒ‰æ„ç¾¤æ‹†åˆ†)";
                    case 3: return "ç²—ç•¥ (é€‚åˆè¿›é˜¶ï¼ŒæŒ‰æ•´å¥/é•¿ä»å¥æ‹†åˆ†)";
                    default: return "æ ‡å‡†";
                }
            };

            const testLLMConnection = async () => {
                if (!localSettings.llmApiKey) { alert("é”™è¯¯ï¼šè¯·å…ˆè¾“å…¥ API Key"); return; }
                setLlmTestStatus('loading');
                try {
                    const response = await fetch(`${localSettings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localSettings.llmApiKey}` },
                        body: JSON.stringify({ model: localSettings.llmModel, messages: [{ role: "user", content: "Hi" }], max_tokens: 5 })
                    });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    const data = await response.json();
                    setLlmTestStatus('success');
                    alert(`è¿æ¥æˆåŠŸï¼\næ¨¡å‹å“åº”: ${JSON.stringify(data.choices?.[0]?.message?.content || "OK")}`);
                } catch (error) { setLlmTestStatus('error'); alert(`è¿æ¥å¤±è´¥: ${error.message}`); }
            };

            const testAzureConnection = async () => {
                if (!localSettings.azureKey || !localSettings.azureRegion) { alert("é”™è¯¯ï¼šè¯·è¡¥å…¨ Region å’Œ Key"); return; }
                setAzureTestStatus('loading');
                try {
                    const endpoint = `https://${localSettings.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`;
                    const ssml = `<speak version='1.0' xml:lang='en-US'><voice xml:lang='en-US' xml:gender='Female' name='en-US-JennyNeural'>Test</voice></speak>`;
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Ocp-Apim-Subscription-Key': localSettings.azureKey, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' },
                        body: ssml
                    });
                    if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                    setAzureTestStatus('success');
                    alert("Azure è¿æ¥æˆåŠŸï¼TTS æœåŠ¡å¯ç”¨ã€‚");
                } catch (error) { setAzureTestStatus('error'); alert(`Azure æµ‹è¯•å¤±è´¥: ${error.message}`); }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                <Settings className="w-5 h-5 text-amber-600" />
                                è®¾ç½®
                            </h2>
                            <button onClick={onClose} className="p-2 -mr-2 text-gray-400 hover:text-gray-600 rounded-full active:bg-gray-200"><X className="w-6 h-6" /></button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto space-y-8 custom-scrollbar">
                            
                            {/* 1. è§£æç²’åº¦è®¾ç½® (æ–°å¢åŠŸèƒ½) */}
                            <div className="space-y-4">
                                <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider border-b pb-1 flex items-center gap-2">
                                    <Layers className="w-4 h-4" /> è§£æç²’åº¦
                                </h3>
                                <div className="bg-amber-50 rounded-lg p-4 border border-amber-100">
                                    <label className="flex justify-between items-center mb-3">
                                        <span className="text-sm font-medium text-gray-700">åˆ†å‰²ç¨‹åº¦</span>
                                        <span className="text-xs font-bold text-amber-700 bg-amber-100 px-2 py-1 rounded border border-amber-200">
                                            {getGranularityLabel(localSettings.parsingGranularity)}
                                        </span>
                                    </label>
                                    <div className="relative pt-1">
                                        <input 
                                            type="range" 
                                            min="1" 
                                            max="3" 
                                            step="1" 
                                            value={localSettings.parsingGranularity || 2}
                                            onChange={(e) => handleChange('parsingGranularity', parseInt(e.target.value))}
                                            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-600" 
                                        />
                                        <div className="flex justify-between text-[10px] text-gray-400 mt-2 font-mono">
                                            <span>| ç»†è‡´</span>
                                            <span>| æ ‡å‡†</span>
                                            <span>| æ•´å¥</span>
                                        </div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-3 leading-relaxed">
                                        * è°ƒæ•´æ­¤é€‰é¡¹å¯æ§åˆ¶ AI åˆ‡åˆ†å¥å­çš„é•¿åº¦ã€‚è®¾ç½®ä¸ºâ€œç»†è‡´â€æ—¶ï¼Œä¼šåˆ‡åˆ†æˆæ›´çŸ­çš„è¯ç»„ï¼›è®¾ç½®ä¸ºâ€œæ•´å¥â€æ—¶ï¼Œé˜…è¯»æ›´æµç•…ã€‚
                                    </p>
                                </div>
                            </div>

                            {/* 2. LLM Config */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-center border-b pb-1">
                                    <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider">AI æ¨¡å‹è®¾ç½®</h3>
                                    {llmTestStatus === 'success' && <span className="text-xs text-green-600 flex items-center"><CheckCircle2 className="w-3 h-3 mr-1"/>å·²è¿æ¥</span>}
                                </div>
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">Base URL</label>
                                        <input type="text" value={localSettings.llmBaseUrl} onChange={(e) => handleChange('llmBaseUrl', e.target.value)} placeholder="https://api.openai.com/v1" className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 outline-none transition-all" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">API Key</label>
                                        <input type="password" value={localSettings.llmApiKey} onChange={(e) => handleChange('llmApiKey', e.target.value)} placeholder="sk-..." className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 outline-none transition-all" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-500 block mb-1">Model Name</label>
                                        <input type="text" value={localSettings.llmModel} onChange={(e) => handleChange('llmModel', e.target.value)} placeholder="gpt-3.5-turbo" className="w-full p-3 border rounded-lg text-sm font-mono bg-slate-50 focus:bg-white focus:ring-2 focus:ring-amber-500 outline-none transition-all" />
                                    </div>
                                    <div className="flex justify-end">
                                        <button onClick={testLLMConnection} className="text-xs border border-amber-200 text-amber-700 px-4 py-2 rounded-lg hover:bg-amber-50 flex items-center gap-1 transition-colors">
                                            {llmTestStatus === 'loading' ? <Loader2 className="w-3 h-3 animate-spin"/> : <Wifi className="w-3 h-3" />} 
                                            æµ‹è¯•è¿æ¥
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* 3. TTS Config */}
                            <div className="space-y-4">
                                <h3 className="font-semibold text-amber-700 text-sm uppercase tracking-wider border-b pb-1">è¯­éŸ³è®¾ç½®</h3>
                                <div className="flex flex-col gap-2">
                                    {['browser', 'openai', 'azure'].map(p => (
                                        <label key={p} className={`flex items-center gap-3 cursor-pointer p-3 rounded-lg border transition-all active:scale-[0.99] ${localSettings.ttsProvider === p ? 'bg-amber-50 border-amber-300 ring-1 ring-amber-300' : 'border-gray-200 hover:bg-gray-50'}`}>
                                            <input type="radio" name="ttsProvider" checked={localSettings.ttsProvider === p} onChange={() => handleChange('ttsProvider', p)} className="w-4 h-4 accent-amber-600" />
                                            <div className="flex flex-col">
                                                <span className="text-sm font-medium text-gray-700">
                                                    {p === 'browser' ? 'æµè§ˆå™¨åŸç”Ÿ (å…è´¹)' : p === 'openai' ? 'OpenAI TTS' : 'Azure Speech'}
                                                </span>
                                                <span className="text-xs text-gray-400">
                                                    {p === 'browser' ? 'ä»…å®æ—¶æœ—è¯»ï¼Œæ— æ³•ä¸‹è½½' : 'æ”¯æŒç”Ÿæˆ MP3'}
                                                </span>
                                            </div>
                                        </label>
                                    ))}
                                </div>
                                {localSettings.ttsProvider === 'azure' && (
                                    <div className="space-y-3 bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <input type="text" value={localSettings.azureRegion} onChange={(e) => handleChange('azureRegion', e.target.value)} placeholder="Region (e.g. eastus)" className="w-full p-2 border rounded text-sm font-mono" />
                                        <input type="password" value={localSettings.azureKey} onChange={(e) => handleChange('azureKey', e.target.value)} placeholder="Key" className="w-full p-2 border rounded text-sm font-mono" />
                                        <div className="flex justify-end"><button onClick={testAzureConnection} className="text-xs border px-3 py-1 rounded hover:bg-white flex items-center gap-1"><Wifi className="w-3 h-3" /> æµ‹è¯• Azure</button></div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end gap-3 safe-pb">
                            <button onClick={() => onSave(localSettings)} className="flex items-center gap-2 bg-amber-600 text-white px-6 py-2.5 rounded-lg hover:bg-amber-700 shadow-sm transition-transform active:scale-95 font-medium w-full justify-center md:w-auto"><Save className="w-4 h-4" /> ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ClickableWord = ({ text, onSpeak, langCode, className = "" }) => {
            const isLong = text.length > 50; 
            if (isLong) {
                return <span className={`${className} cursor-pointer hover:bg-amber-100 transition-colors`} onClick={(e) => { e.stopPropagation(); onSpeak(text, langCode); }}>{text}</span>
            }
            const words = text.split(/(\s+)/);
            return (
                <span className={className}>
                    {words.map((seg, index) => {
                        if (seg.trim() === "") return <span key={index}>{seg}</span>;
                        return (
                            <span key={index} onClick={(e) => { e.stopPropagation(); onSpeak(seg.replace(/[.,/#!$%^&*;:{}=\-_`~()]/g, ""), langCode); }}
                                className="cursor-pointer hover:bg-amber-200 hover:text-amber-900 rounded px-0.5 transition-colors duration-150 select-text active:scale-95 inline-block touch-manipulation">
                                {seg}
                            </span>
                        );
                    })}
                </span>
            );
        };

        // -----------------------------------------------------------------------------
        // MAIN APP
        // -----------------------------------------------------------------------------
        const IlyaFrankReader = () => {
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [showSettings, setShowSettings] = useState(false);
            
            // App State
            const [inputText, setInputText] = useState("");
            const [ilyaData, setIlyaData] = useState([]);
            const [rawText, setRawText] = useState("");
            const [targetLang, setTargetLang] = useState('en'); 
            const [targetLevel, setTargetLevel] = useState('B1'); 
            
            const [isProcessing, setIsProcessing] = useState(false); 
            const [isGenerating, setIsGenerating] = useState(false); 
            
            // Audio State
            const [fullAudioUrl, setFullAudioUrl] = useState(null);
            const [isGeneratingAudio, setIsGeneratingAudio] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [playbackRate, setPlaybackRate] = useState(1.0);

            // Refs
            const synthRef = useRef(window.speechSynthesis);
            const audioRef = useRef(new Audio());

            useEffect(() => {
                const saved = localStorage.getItem('ilya_reader_settings');
                if (saved) { try { setSettings({ ...DEFAULT_SETTINGS, ...JSON.parse(saved) }); } catch (e) {} }
            }, []);

            // æ¸…ç† URL
            useEffect(() => {
                return () => {
                    if (fullAudioUrl) URL.revokeObjectURL(fullAudioUrl);
                };
            }, [fullAudioUrl]);

            // Audio Player Listeners
            useEffect(() => {
                const audio = audioRef.current;
                const updateTime = () => setCurrentTime(audio.currentTime);
                const updateDuration = () => setDuration(audio.duration);
                const onEnded = () => setIsPlaying(false);
                const onError = (e) => { console.error("Audio error", e); setIsPlaying(false); };

                audio.addEventListener('timeupdate', updateTime);
                audio.addEventListener('loadedmetadata', updateDuration);
                audio.addEventListener('ended', onEnded);
                audio.addEventListener('error', onError);

                return () => {
                    audio.removeEventListener('timeupdate', updateTime);
                    audio.removeEventListener('loadedmetadata', updateDuration);
                    audio.removeEventListener('ended', onEnded);
                    audio.removeEventListener('error', onError);
                    audio.pause();
                };
            }, []);

            useEffect(() => {
                if (audioRef.current) audioRef.current.playbackRate = playbackRate;
            }, [playbackRate]);

            // --- TTS Core ---

            const handleWordClick = async (text, langCode) => {
                if (!text || !text.trim()) return;

                if (isPlaying) {
                    if (settings.ttsProvider === 'browser') synthRef.current.cancel();
                    else audioRef.current.pause();
                    setIsPlaying(false);
                }

                if (settings.ttsProvider === 'browser' || true) {
                    synthRef.current.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = langCode || LANGUAGES[targetLang].ttsCode; 
                    u.rate = 0.9;
                    synthRef.current.speak(u);
                }
            };

            const generateFullAudio = async () => {
                if (!rawText) return alert("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥æ–‡æœ¬å¹¶ç‚¹å‡»'æ™ºèƒ½è§£æ'æˆ–'ç”Ÿæˆ'");
                if (settings.ttsProvider === 'browser') return alert("æç¤ºï¼šå½“å‰é€‰æ‹©çš„æ˜¯æµè§ˆå™¨åŸç”Ÿ TTSï¼Œå®ƒåªèƒ½å®æ—¶æœ—è¯»ï¼Œæ— æ³•ç”ŸæˆéŸ³é¢‘æ–‡ä»¶ã€‚å¦‚éœ€ä¸‹è½½ MP3ï¼Œè¯·åœ¨è®¾ç½®ä¸­åˆ‡æ¢ä¸º OpenAI æˆ– Azure TTSã€‚");
                
                setIsGeneratingAudio(true);
                audioRef.current.pause();
                setIsPlaying(false);
                if (fullAudioUrl) URL.revokeObjectURL(fullAudioUrl);
                setFullAudioUrl(null);

                try {
                    let blob;
                    if (settings.ttsProvider === 'openai') {
                        if (!settings.llmApiKey) throw new Error("è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ API Key");
                        const response = await fetch(`${settings.llmBaseUrl}/audio/speech`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${settings.llmApiKey}`, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: 'tts-1', input: rawText, voice: settings.ttsVoice, speed: 1.0 })
                        });
                        if (!response.ok) throw new Error("OpenAI TTS è¯·æ±‚å¤±è´¥");
                        blob = await response.blob();
                    } else if (settings.ttsProvider === 'azure') {
                        if (!settings.azureKey) throw new Error("è¯·åœ¨è®¾ç½®ä¸­å¡«å†™ Azure Key");
                        const voiceName = LANGUAGES[targetLang].azureVoice;
                        const response = await fetch(`https://${settings.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`, {
                            method: 'POST',
                            headers: { 'Ocp-Apim-Subscription-Key': settings.azureKey, 'Content-Type': 'application/ssml+xml', 'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3' },
                            body: `<speak version='1.0' xml:lang='${LANGUAGES[targetLang].ttsCode}'><voice xml:lang='${LANGUAGES[targetLang].ttsCode}' xml:gender='Female' name='${voiceName}'>${rawText}</voice></speak>`
                        });
                        if (!response.ok) throw new Error("Azure TTS è¯·æ±‚å¤±è´¥");
                        blob = await response.blob();
                    }

                    const url = URL.createObjectURL(blob);
                    setFullAudioUrl(url);
                    audioRef.current.src = url;
                    audioRef.current.load();
                } catch (e) {
                    alert("ç”ŸæˆéŸ³é¢‘å¤±è´¥: " + e.message);
                } finally {
                    setIsGeneratingAudio(false);
                }
            };

            const togglePlay = () => {
                if (settings.ttsProvider === 'browser') {
                    if (isPlaying) {
                        synthRef.current.cancel();
                        setIsPlaying(false);
                    } else {
                        if(!rawText) return;
                        const u = new SpeechSynthesisUtterance(rawText);
                        u.lang = LANGUAGES[targetLang].ttsCode;
                        u.rate = playbackRate;
                        u.onend = () => setIsPlaying(false);
                        synthRef.current.cancel(); 
                        synthRef.current.speak(u);
                        setIsPlaying(true);
                    }
                    return;
                }

                if (!fullAudioUrl) {
                    generateFullAudio().then(() => {
                        if (audioRef.current.src) {
                            audioRef.current.play();
                            setIsPlaying(true);
                        }
                    });
                } else {
                    if (isPlaying) {
                        audioRef.current.pause();
                        setIsPlaying(false);
                    } else {
                        audioRef.current.play();
                        setIsPlaying(true);
                    }
                }
            };

            const handleSeek = (e) => {
                const time = parseFloat(e.target.value);
                setCurrentTime(time);
                audioRef.current.currentTime = time;
            };

            // --- AI Actions ---

            const generateText = async () => {
                if (!settings.llmApiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");
                setIsGenerating(true);
                try {
                    const prompt = `Write a ${CEFR_LEVELS.indexOf(targetLevel) < 2 ? 'simple' : 'complex'} story in ${LANGUAGES[targetLang].prompt} (CEFR ${targetLevel}, ~300 words). Output the story text ONLY. Do NOT include Markdown formatting.`;
                    
                    const response = await fetch(`${settings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.llmApiKey}` },
                        body: JSON.stringify({ model: settings.llmModel, messages: [{ role: "user", content: prompt }], temperature: 0.7 })
                    });
                    const data = await response.json();
                    const content = data.choices?.[0]?.message?.content?.replace(/```/g, '').trim() || "";
                    setInputText(content);
                } catch (error) { alert("ç”Ÿæˆå¤±è´¥: " + error.message); } finally { setIsGenerating(false); }
            };

            const parseText = async () => {
                if (!inputText.trim()) return alert("è¯·è¾“å…¥éœ€è¦è§£æçš„æ–‡æœ¬");
                if (!settings.llmApiKey) return alert("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");
                
                setIsProcessing(true);
                setRawText(inputText);
                setFullAudioUrl(null); 
                
                try {
                    const langName = LANGUAGES[targetLang].prompt;
                    
                    // --- åŠ¨æ€ç²’åº¦æŒ‡ä»¤ ---
                    let granularityInstruction = "";
                    switch(parseInt(settings.parsingGranularity || 2)) {
                        case 1: 
                            granularityInstruction = "Split the text into very small, granular chunks (2-5 words max). Focus on breaking down individual vocabulary and idioms for a beginner learner.";
                            break;
                        case 3:
                            granularityInstruction = "Split the text by full sentences or very long logical clauses only. Do not break sentences mid-way unless they are extremely long complex sentences.";
                            break;
                        default: // 2
                            granularityInstruction = "Split the text by natural logical phrases (sense groups) for standard reading flow. Avoid splitting simple subject-verb-object structures.";
                    }

                    const prompt = `
                        You are an expert in Ilya Frank's Reading Method.
                        Task: Segment the following ${langName} text and provide Chinese explanations.
                        
                        Parsing Rule: ${granularityInstruction}
                        
                        CRITICAL RULES:
                        1. field "original": MUST contain the original ${langName} text. DO NOT TRANSLATE "original" into English.
                        2. field "cn": Chinese translation and brief grammatical note (in brackets).
                        
                        Format: JSON Array ONLY. 
                        Example format: [{"original": "ĞœĞ°Ğ¼Ğ°", "cn": "å¦ˆå¦ˆ"}, {"original": "Ğ¼Ñ‹Ğ»Ğ°", "cn": "æ´—äº† (è¿‡å»æ—¶)"}]
                        
                        Text to process:
                        ${inputText}
                    `;
                    
                    const response = await fetch(`${settings.llmBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.llmApiKey}` },
                        body: JSON.stringify({ 
                            model: settings.llmModel, 
                            messages: [
                                { role: "system", content: "You are a JSON generator. Output valid JSON array only. Preserve original language text." }, 
                                { role: "user", content: prompt }
                            ], 
                            temperature: 0.1 
                        })
                    });
                    
                    const data = await response.json();
                    let content = data.choices?.[0]?.message?.content || "";
                    
                    content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                    const start = content.indexOf('[');
                    const end = content.lastIndexOf(']');
                    if (start !== -1 && end !== -1) {
                        content = content.substring(start, end + 1);
                    }
                    
                    const parsed = JSON.parse(content);
                    const normalized = parsed.map(item => ({
                        original: item.original || item.en || item.text, 
                        cn: item.cn || item.zh || item.translation
                    }));
                    
                    setIlyaData(normalized);
                } catch (error) { 
                    console.error(error); 
                    alert("è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–é‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯: " + error.message); 
                } finally { 
                    setIsProcessing(false); 
                }
            };

            const loadSample = () => {
                setTargetLang(SAMPLE_CONTENT.lang); 
                setInputText(SAMPLE_CONTENT.raw);
                setRawText(SAMPLE_CONTENT.raw); 
                setIlyaData(SAMPLE_CONTENT.ilyaSegments); 
                setFullAudioUrl(null);
            };

            const saveSettings = (s) => { setSettings(s); localStorage.setItem('ilya_reader_settings', JSON.stringify(s)); setShowSettings(false); };

            // --- Render ---
            return (
                <div className="min-h-screen flex flex-col mobile-pb-fix"> 
                    <SettingsModal isOpen={showSettings} onClose={() => setShowSettings(false)} settings={settings} onSave={saveSettings} />

                    {/* Header */}
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-amber-100 p-2 rounded-lg">
                                    <BookOpen className="text-amber-600 w-5 h-5" />
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold text-slate-800 leading-tight">Ilya Frank</h1>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={loadSample} className="p-2 text-slate-600 hover:bg-slate-100 rounded-full transition-colors md:px-3 md:py-1.5 md:rounded-md flex items-center">
                                    <RotateCcw className="w-5 h-5 md:w-3.5 md:h-3.5"/> 
                                    <span className="hidden md:inline ml-1 text-xs font-medium">ç¤ºä¾‹</span>
                                </button>
                                <button onClick={() => setShowSettings(true)} className="p-2 text-slate-800 bg-slate-100 rounded-full hover:bg-slate-200 transition-colors md:bg-slate-800 md:text-white md:hover:bg-slate-700 md:px-3 md:py-1.5 md:rounded-md flex items-center shadow-sm">
                                    <Settings className="w-5 h-5 md:w-3.5 md:h-3.5"/>
                                    <span className="hidden md:inline ml-1 text-xs font-medium">è®¾ç½®</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-grow max-w-7xl mx-auto w-full p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                        
                        {/* Left Column: Input */}
                        <div className="flex flex-col gap-4 h-full">
                            <section className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-5 space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                        <Globe className="w-4 h-4 text-amber-500" /> åŸæ–‡
                                    </h2>
                                    <div className="flex gap-2">
                                         <select value={targetLang} onChange={(e) => setTargetLang(e.target.value)} className="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-md px-2 py-1 outline-none focus:border-amber-500">
                                            {Object.entries(LANGUAGES).map(([c, cfg]) => <option key={c} value={c}>{cfg.label}</option>)}
                                        </select>
                                        <button onClick={() => setInputText('')} className="text-slate-400 hover:text-red-500 transition-colors p-2" title="æ¸…ç©º"><Eraser className="w-4 h-4"/></button>
                                    </div>
                                </div>
                                
                                <textarea 
                                    value={inputText} 
                                    onChange={(e) => setInputText(e.target.value)} 
                                    placeholder="åœ¨æ­¤ç²˜è´´ä¿„è¯­ã€å¾·è¯­ç­‰æ–‡ç« ç‰‡æ®µ..." 
                                    className="w-full p-4 rounded-lg border border-slate-200 min-h-[180px] md:min-h-[240px] text-base leading-relaxed resize-y focus:ring-2 focus:ring-amber-500 focus:border-transparent outline-none bg-slate-50 font-serif"
                                />

                                <div className="flex flex-col sm:flex-row items-center justify-between gap-3 pt-2 border-t border-slate-100">
                                    <div className="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-slate-400">AIç´ æ:</span>
                                            <select value={targetLevel} onChange={(e) => setTargetLevel(e.target.value)} className="bg-white border text-xs rounded px-1 py-1">
                                                {CEFR_LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                            </select>
                                        </div>
                                        <button onClick={generateText} disabled={isGenerating} className="text-xs text-amber-600 hover:text-amber-700 flex items-center gap-1 font-medium disabled:opacity-50 px-2 py-1 bg-amber-50 rounded">
                                            {isGenerating ? <Loader2 className="w-3 h-3 animate-spin"/> : <Sparkles className="w-3 h-3"/>} ç”Ÿæˆæ•…äº‹
                                        </button>
                                    </div>
                                    <button 
                                        onClick={parseText} 
                                        disabled={isProcessing || !inputText.trim()} 
                                        className="w-full sm:w-auto bg-amber-600 text-white px-5 py-2.5 rounded-lg text-sm font-semibold shadow-sm hover:bg-amber-700 disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all active:scale-95"
                                    >
                                        {isProcessing ? <Loader2 className="w-4 h-4 animate-spin"/> : <Type className="w-4 h-4"/>} 
                                        å¼€å§‹è§£æ
                                    </button>
                                </div>
                            </section>
                            
                            {/* Tip Box (Hidden on small mobile to save space, visible on tablet+) */}
                            <div className="hidden sm:block bg-blue-50 text-blue-800 text-xs p-3 rounded-lg border border-blue-100 leading-relaxed">
                                <span className="font-bold block mb-1">ğŸ’¡ ä½¿ç”¨æŠ€å·§ï¼š</span>
                                1. ç‚¹å‡»ä»»æ„å•è¯å¯å‘éŸ³ã€‚<br/>
                                2. åœ¨â€œè®¾ç½®â€ä¸­å¯ä»¥è°ƒæ•´â€œè§£æç²’åº¦â€ï¼Œæ§åˆ¶å¥å­åˆ‡åˆ†çš„ç»†ç¢ç¨‹åº¦ã€‚<br/>
                                3. æ‰‹æœºæ¨ªå±ä½¿ç”¨ä½“éªŒæ›´ä½³ã€‚
                            </div>
                        </div>

                        {/* Right Column: Parsed Output */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 min-h-[400px] flex flex-col h-full">
                             <div className="px-5 py-3 border-b border-slate-100 bg-amber-50/30 flex justify-between items-center rounded-t-xl">
                                <h2 className="font-bold text-slate-700 flex items-center gap-2">
                                    <BookOpen className="w-4 h-4 text-amber-500" /> é˜…è¯»åŒº
                                </h2>
                            </div>
                            
                            <div className="p-4 md:p-6 flex-grow overflow-y-auto max-h-[60vh] md:max-h-[calc(100vh-250px)] touch-pan-y">
                                {ilyaData.length > 0 ? (
                                    <div className="text-lg leading-loose font-serif text-slate-800 text-justify">
                                        {ilyaData.map((seg, idx) => (
                                            <span key={idx} className="inline mr-1 break-words">
                                                {/* æ¸²æŸ“åŸæ–‡ */}
                                                <ClickableWord 
                                                    text={seg.original} 
                                                    langCode={LANGUAGES[targetLang].ttsCode}
                                                    onSpeak={handleWordClick} 
                                                    className="font-semibold text-slate-900 border-b-2 border-transparent hover:border-amber-300 transition-all cursor-pointer py-0.5" 
                                                />
                                                {/* æ¸²æŸ“ä¸­æ–‡ */}
                                                {seg.cn && (
                                                    <span className="mx-1 text-base text-slate-500 font-sans bg-slate-100 px-1.5 py-0.5 rounded-md inline-block my-1">
                                                        ({seg.cn})
                                                    </span>
                                                )}
                                            </span>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-300 py-20">
                                        <BookOpen className="w-12 h-12 mb-4 opacity-20" />
                                        <p>ç­‰å¾…è§£æ...</p>
                                    </div>
                                )}
                            </div>
                        </div>

                    </main>

                    {/* Bottom Player */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-200 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.1)] z-30 safe-pb px-4 py-3">
                        <div className="max-w-4xl mx-auto flex flex-col gap-2">
                            {/* Progress */}
                            <div className="flex items-center gap-3 w-full">
                                <span className="text-xs text-slate-400 font-mono w-10 text-right">{formatTime(currentTime)}</span>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max={duration || 100} 
                                    value={currentTime} 
                                    onChange={handleSeek}
                                    disabled={!fullAudioUrl && settings.ttsProvider !== 'browser'}
                                    className="flex-grow accent-amber-600 disabled:opacity-50 h-8"
                                />
                                <span className="text-xs text-slate-400 font-mono w-10">{formatTime(duration)}</span>
                            </div>

                            {/* Controls */}
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 w-24 md:w-32">
                                     <Volume2 className="w-4 h-4 text-slate-400" />
                                     <select 
                                        value={playbackRate} 
                                        onChange={(e) => setPlaybackRate(parseFloat(e.target.value))}
                                        className="bg-slate-100 border-none text-xs rounded px-2 py-1.5 text-slate-600 outline-none"
                                    >
                                        <option value="0.8">0.8x</option>
                                        <option value="1.0">1.0x</option>
                                        <option value="1.2">1.2x</option>
                                        <option value="1.5">1.5x</option>
                                     </select>
                                </div>

                                <button 
                                    onClick={togglePlay}
                                    disabled={isGeneratingAudio}
                                    className={`w-12 h-12 flex items-center justify-center rounded-full text-white shadow-lg shadow-amber-200 transition-all active:scale-95 disabled:bg-slate-300 disabled:shadow-none
                                        ${isPlaying ? 'bg-amber-600 hover:bg-amber-700' : 'bg-amber-500 hover:bg-amber-600'}`}
                                >
                                    {isGeneratingAudio ? (
                                        <Loader2 className="w-5 h-5 animate-spin" />
                                    ) : isPlaying ? (
                                        <Pause className="w-5 h-5 fill-current" />
                                    ) : (
                                        <Play className="w-5 h-5 fill-current ml-1" />
                                    )}
                                </button>
                                
                                <div className="w-24 md:w-32 flex justify-end">
                                    {settings.ttsProvider !== 'browser' && !fullAudioUrl && (
                                        <button 
                                            onClick={generateFullAudio}
                                            disabled={!rawText || isGeneratingAudio}
                                            className="flex items-center gap-1 text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full hover:bg-blue-100 transition-colors font-medium whitespace-nowrap"
                                        >
                                            <Music className="w-3 h-3" /> <span className="hidden sm:inline">ç”ŸæˆéŸ³é¢‘</span><span className="sm:hidden">ç”Ÿæˆ</span>
                                        </button>
                                    )}
                                    {settings.ttsProvider === 'browser' && <span className="text-xs text-slate-400">æµè§ˆå™¨æœ—è¯»</span>}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const formatTime = (seconds) => {
            if (!seconds || isNaN(seconds)) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<IlyaFrankReader />);
    </script>
</body>
</html>